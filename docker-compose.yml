services:
  db:
    image: registry.suse.com/suse/mariadb:10.11
    restart: unless-stopped
    volumes:
      - mariadb:/var/lib/mysql
    env_file: '.env'

  testdb:
    # ephemeral test instance of DB with no storage attached
    image: registry.suse.com/suse/mariadb:10.11
    profiles:
      # assign to test profile so it only runs if explicitly selected
      - test
    restart: unless-stopped
    networks:
      # use a separate network for service isolation
      - test
    env_file: '.env'
    # override env settings
    environment:
      MYSQL_DATABASE: rmt_test
      MYSQL_HOST: testdb

  rmt:
    build: .
    # name rmt image so it can be re-used
    image: rmt-rmt
    restart: unless-stopped
    env_file: '.env'
    volumes:
      - .:/srv/www/rmt
      - ./config/rmt.yml:/etc/rmt.conf
    depends_on:
      - db
    pre_stop:
      - command: rm -f /srv/www/rmt/tmp/pids/server.pid
    privileged: true
    command: bundle exec rails runner /srv/www/rmt/bin/compose-init.rb

  testrmt:
    # re-use image built for rmt
    image: rmt-rmt
    profiles:
      # assign to test profile so it only runs if explicitly selected
      - test
    networks:
      # use a separate network for service isolation
      - test
    env_file: '.env'
    # override env settings
    environment:
      RAILS_ENV: test
      MYSQL_HOST: testdb
      MYSQL_DATABASE: rmt_test
    volumes:
      - .:/srv/www/rmt
    depends_on:
      - testdb
    privileged: true
    command: /bin/bash

  nginx:
    image: nginx:1.14
    volumes:
      - ./public:/var/www/
      - ./nginx/default.conf:/tmp/default.template
    ports:
      - "${EXTERNAL_PORT}:80"
    depends_on:
      - rmt
    entrypoint: /bin/bash -c 'cat /tmp/default.template | sed "s/\\\$$server_port/$EXTERNAL_PORT/g" > /etc/nginx/conf.d/default.conf && nginx -g "daemon off;"'

volumes:
  mariadb:
    driver: local
  db_storage:
    driver: local

networks:
  default:
    name: rmt_default
  test:
    name: rmt_test